
Manga = {
	pageloaded: function(){
		$('#volumelist').on('click', '.icon-remove', function(e){
			var $icn = $(e.target);
			var $li = $icn.closest('li');
			var seriesKey = $icn.closest('.container').attr('id');
			var bookId = $li.attr('id');
			var $anchor = $li.find('a').first();
			var text = $anchor.text();
			var clickedTop = $icn.offset().top;
			bootbox.confirm("You're about to delete " + text + '!!'
			 + '<br>Continue?', function(confirmed){
			 	if(confirmed)
					$icn.parent().removeClass('btn btn-mini btn-inverse');
					$icn.removeClass('icon-remove').addClass('icon-download');
					var dataUrl = 'http://mangafox.me/manga';
					if($anchor.hasClass('chapterlink')){
						// revert to orig
						dataUrl += '/' + seriesKey + $anchor.attr('data-url').split(seriesKey)[1] + bookId + '/1.html';
					}
					else{
						dataUrl = '/' + seriesKey + '/' + bookId + '.html';
 					}
 					$anchor.attr('data-url', dataUrl);
 					Manga.deletEbook(seriesKey, bookId);
			});
			Manga.alignBootBox(clickedTop);

		});
	},


	deletEbook: function(seriesKey, bookId){
		$.get('/ajax/deletebook', {key: seriesKey, field: bookId}, function(data){
			if(data.err) console.log(data.err);
		});
	},

	// posts because of big arrays
	generatEbook: function(id, bookRef, title, listOfChapters){
		$.post('/ajax/generatebook', {list: listOfChapters, bookref: bookRef, title: title, id: id}, function(data){
			if(data.err) console.log(data.err);
		});
	},

	getNrOfPagesFromList: function(listOfChapters, callback){
		$.post('/ajax/getnrofpagesfromlist', {list: listOfChapters}, function(data){
			callback(data);
		});
	},

	alignBootBox: function(clickedTop){
		// bootbox at correct height: bottom in middle of clicked element
		// background-height = document (<-> window if position fixed)
		$('.modal').css({'margin-top': clickedTop - $('.modal').height() + $('.chapterlink').height(), 'top': 0});
		$('.modal-backdrop.fade').css({'height': $(document).height()});
	},

	checkForDownload: function(id){
		var $jQelem = $('#' + id);
		var $spinner = $jQelem;
		// Kindle PW browser doesn't support scrollTop nor its alternatives
		var clickedTop = $jQelem.offset().top;
		var url = $jQelem.find('a').first().attr('data-url');
		var extension = url.split('.').slice(-1)[0];
		if(extension === 'mobi' || extension === 'epub'){
			window.location = url;
		}
		else{

			if((/#$/).test(url)){
				bootbox.alert("Already processing this ebook!");
				Manga.alignBootBox(clickedTop);
			}

			else{ // generate new ebook
				var listOfChapters = [];
				var bookRef = '';
				// if volume, get chapterurls -> volume-url is not generated by mangafox and ends (=slice(-1)) in /v00.html
				var isVolume = (/v[0-9][0-9]/).test(url.split('/').slice(-1));
				if(isVolume){
					// first a is volume itself
					var $chapterElems = $jQelem.find('a').slice(1);
					listOfChapters = $chapterElems.map(function(){return this.getAttribute('data-url');}).get();
					bookRef = url.split('.')[0];
					// better to spin small black div
					$spinner = $jQelem.children().first();
				}
				else {
					listOfChapters.push(url);
					bookRef = url.split('mangafox.me/manga')[1].split('/').slice(0, -1).join('/');
				}
				if(isVolume) $spinner.spin('large', '#fff');
				else $spinner.spin('large');
				Manga.getNrOfPagesFromList(listOfChapters, function(data){
					if(data.err){
						bootbox.alert('Error: ' + data.err);
						Manga.alignBootBox(clickedTop);
					}
					$spinner.spin(false);
					if(data && data.nrofpages){
						var $anchor = $jQelem.find('a').first();
						var title = $anchor.text();
						bootbox.confirm("You're about to generate an ebook of " + data.nrofpages + ' pages, holding '
						+ title + '<br>Continue?', function(confirmed){
							if(confirmed){
								var $icon = $jQelem.find('i').first();
								$icon.removeClass('icon-download');
								$icon.addClass('icon-refresh');
								$anchor.attr('data-url', '#');
								// hack to be able to store id in dbase upon save -> necessary to generate images for /local
								var id = window.location.search.split('=')[1];
								Manga.generatEbook(id, bookRef, title, listOfChapters);
							}
						});
						Manga.alignBootBox(clickedTop);
					}
				});
			}
		}
	}
};

$(Manga.pageloaded);